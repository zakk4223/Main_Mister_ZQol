From 730b0eeb004817dd7514f6541dd68c643c479862 Mon Sep 17 00:00:00 2001
From: Zakk <zakk@rsdio.com>
Date: Sat, 13 Feb 2021 17:35:28 -0500
Subject: [PATCH] Add nvram clear option

---
 menu.cpp                      | 15 +++++++++++++++
 support/arcade/mra_loader.cpp | 21 +++++++++++++++++++++
 support/arcade/mra_loader.h   |  2 ++
 3 files changed, 38 insertions(+)

diff --git a/menu.cpp b/menu.cpp
index 6376d3c..ddca5f3 100644
--- a/menu.cpp
+++ b/menu.cpp
@@ -1013,6 +1013,7 @@ void HandleUI(void)
 	static unsigned long flash_timer = 0;
 	static int flash_state = 0;
 	static uint32_t dip_submenu;
+	static uint32_t clear_nvm_submenu;
 	static int need_reset = 0;
 	static int flat = 0;
 	static int menusub_parent = 0;
@@ -1556,6 +1557,7 @@ void HandleUI(void)
 			else OsdSetTitle(title);
 
 			dip_submenu = -1;
+			clear_nvm_submenu = -1;
 
 			int last_space = 0;
 
@@ -1797,6 +1799,15 @@ void HandleUI(void)
 				}
 			} while (p);
 
+			if (arcade_has_nvm())
+			{
+				clear_nvm_submenu = selentry;
+				MenuWrite(entry, " Clear NVRAM", menusub == selentry, 0);
+			        entry++;
+			        selentry++;
+				menumask = (menumask << 1) | 1;
+			}
+
 			if (!entry) break;
 
 			for (; entry < OsdGetSize() - 1; entry++) MenuWrite(entry, "", 0, 0);
@@ -1892,6 +1903,10 @@ void HandleUI(void)
 				menustate = MENU_ARCADE_DIP1;
 				menusub = 0;
 			}
+			else if (clear_nvm_submenu == menusub && select)
+			{
+				arcade_nvm_clear();
+			}
 			else
 			{
 				static char ext[256];
diff --git a/support/arcade/mra_loader.cpp b/support/arcade/mra_loader.cpp
index b224ba1..c92fbc2 100644
--- a/support/arcade/mra_loader.cpp
+++ b/support/arcade/mra_loader.cpp
@@ -54,6 +54,27 @@ static int  nvram_idx  = 0;
 static int  nvram_size = 0;
 static char nvram_name[200] = {};
 
+bool arcade_has_nvm()
+{
+	if (nvram_idx && nvram_size)
+	{
+		return true;
+	}
+
+	return false;
+}
+
+void arcade_nvm_clear()
+{
+	if (nvram_idx && nvram_size)
+	{
+		char path[256] = CONFIG_DIR"/nvram/";
+		strcat(path, nvram_name);
+		FileDelete(path);
+	}
+}
+
+
 void arcade_nvm_save()
 {
 	if(nvram_idx && nvram_size)
diff --git a/support/arcade/mra_loader.h b/support/arcade/mra_loader.h
index a5c8864..67387d9 100644
--- a/support/arcade/mra_loader.h
+++ b/support/arcade/mra_loader.h
@@ -35,5 +35,7 @@ void arcade_sw_load();
 void arcade_override_name(const char *xml);
 
 void arcade_nvm_save();
+bool arcade_has_nvm();
+void arcade_nvm_clear();
 
 #endif
-- 
2.30.1

