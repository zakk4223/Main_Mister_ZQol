From 4c373d9c199f483f3fe5a880e0e9ff612066e8c6 Mon Sep 17 00:00:00 2001
From: Zakk <zakk@rsdio.com>
Date: Sun, 13 Mar 2022 19:29:54 -0400
Subject: [PATCH 2/5] 0002

---
 menu.cpp                      | 17 +++++++++++++++++
 support/arcade/mra_loader.cpp | 21 +++++++++++++++++++++
 support/arcade/mra_loader.h   |  2 ++
 3 files changed, 40 insertions(+)

diff --git a/menu.cpp b/menu.cpp
index 135e91c..0f29360 100644
--- a/menu.cpp
+++ b/menu.cpp
@@ -1011,6 +1011,7 @@ void HandleUI(void)
 	static unsigned long flash_timer = 0;
 	static int flash_state = 0;
 	static uint32_t dip_submenu, dip2_submenu, dipv;
+	static uint32_t clear_nvm_submenu;
 	static int need_reset = 0;
 	static int flat = 0;
 	static int menusub_parent = 0;
@@ -1614,6 +1615,8 @@ void HandleUI(void)
 
 			dip_submenu = -1;
 			dip2_submenu = -1;
+			clear_nvm_submenu = -1;
+
 
 			int last_space = 0;
 
@@ -1873,6 +1876,16 @@ void HandleUI(void)
 				}
 			} while (p);
 
+
+			if (arcade_has_nvm())
+			{
+				clear_nvm_submenu = selentry;
+				MenuWrite(entry, " Clear NVRAM", menusub == selentry, 0);
+				entry++;
+				selentry++;
+				menumask = (menumask << 1) | 1;
+			}
+
 			if (!entry) break;
 
 			for (; entry < OsdGetSize() - 1; entry++) MenuWrite(entry, "", 0, 0);
@@ -1984,6 +1997,10 @@ void HandleUI(void)
 				menustate = MENU_ARCADE_DIP1;
 				menusub = 0;
 			}
+			else if (clear_nvm_submenu == menusub && select)
+			{
+				arcade_nvm_clear();
+			}
 			else
 			{
 				static char ext[256];
diff --git a/support/arcade/mra_loader.cpp b/support/arcade/mra_loader.cpp
index 5593428..0429413 100644
--- a/support/arcade/mra_loader.cpp
+++ b/support/arcade/mra_loader.cpp
@@ -55,6 +55,27 @@ static int  nvram_idx  = 0;
 static int  nvram_size = 0;
 static char nvram_name[200] = {};
 
+
+bool arcade_has_nvm()
+{
+       if (nvram_idx && nvram_size)
+       {
+               return true;
+       }
+
+       return false;
+}
+
+void arcade_nvm_clear()
+{
+       if (nvram_idx && nvram_size)
+       {
+               char path[256] = CONFIG_DIR"/nvram/";
+               strcat(path, nvram_name);
+               FileDelete(path);
+       }
+}
+
 void arcade_nvm_save()
 {
 	if(nvram_idx && nvram_size)
diff --git a/support/arcade/mra_loader.h b/support/arcade/mra_loader.h
index 031b831..ecd3f25 100644
--- a/support/arcade/mra_loader.h
+++ b/support/arcade/mra_loader.h
@@ -62,6 +62,8 @@ void arcade_sw_load(int n);
 void arcade_override_name(const char *xml);
 
 void arcade_nvm_save();
+bool arcade_has_nvm();
+void arcade_nvm_clear();
 
 mgl_struct* mgl_parse(const char *xml);
 mgl_struct* mgl_get();
-- 
2.35.1

