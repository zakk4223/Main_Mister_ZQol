From 35f14817c9bb2cc0077a1c17f440ef1b91f2df34 Mon Sep 17 00:00:00 2001
From: Zakk <zakk@rsdio.com>
Date: Sat, 13 Feb 2021 17:37:26 -0500
Subject: [PATCH] Read rbf name and setname ini config sections

---
 cfg.cpp     |  6 +++++-
 user_io.cpp | 11 ++++++++++-
 user_io.h   |  1 +
 3 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/cfg.cpp b/cfg.cpp
index 671ac6b..38fc0d5 100644
--- a/cfg.cpp
+++ b/cfg.cpp
@@ -174,7 +174,11 @@ static int ini_get_section(char* buf)
 		else buf[i] = toupper(buf[i]);
 	}
 
-	if (!strcasecmp(buf, "MiSTer") || ((wc_pos >= 0) ? !strncasecmp(buf, user_io_get_core_name_ex(), wc_pos) : !strcasecmp(buf, user_io_get_core_name_ex())))
+        bool read_section_rbf = (wc_pos >= 0) ? !strncasecmp(buf, user_io_get_core_name_rbf(), wc_pos) : !strcasecmp(buf, user_io_get_core_name_rbf());
+        bool read_section_core = (wc_pos >= 0) ? !strncasecmp(buf, user_io_get_core_name_ex(), wc_pos) : !strcasecmp(buf, user_io_get_core_name_ex());
+
+	printf("CORE %s RBF %s\n", user_io_get_core_name_ex(), user_io_get_core_name_rbf());
+	if (!strcasecmp(buf, "MiSTer") || read_section_rbf || read_section_core)
 	{
 		ini_parser_debugf("Got SECTION '%s'", buf);
 		return 1;
diff --git a/user_io.cpp b/user_io.cpp
index f46b6db..61796df 100644
--- a/user_io.cpp
+++ b/user_io.cpp
@@ -130,6 +130,7 @@ char* user_io_create_config_name()
 }
 
 static char core_name[32] = {};
+static char core_name_rbf[32] = {};
 static char filepath_store[1024];
 
 char *user_io_make_filepath(const char *path, const char *filename)
@@ -172,6 +173,11 @@ char *user_io_get_core_path(const char *suffix, int recheck)
 	return tmp;
 }
 
+const char *user_io_get_core_name_rbf()
+{
+	return core_name_rbf;
+}
+
 const char *user_io_get_core_name_ex()
 {
 	switch (user_io_core_type())
@@ -315,10 +321,13 @@ void user_io_read_core_name()
 	core_name[0] = 0;
 
 	// get core name
+	char *p = user_io_get_confstr(0);
+
+	if (p && p[0]) strcpy(core_name_rbf, p);
+
 	if (ovr_name[0]) strcpy(core_name, ovr_name);
 	else
 	{
-		char *p = user_io_get_confstr(0);
 		if (p && p[0]) strcpy(core_name, p);
 	}
 
diff --git a/user_io.h b/user_io.h
index d1fdd5b..2c952d3 100644
--- a/user_io.h
+++ b/user_io.h
@@ -198,6 +198,7 @@ uint32_t user_io_get_file_crc();
 int  user_io_file_mount(const char *name, unsigned char index = 0, char pre = 0);
 char *user_io_make_filepath(const char *path, const char *filename);
 char *user_io_get_core_name();
+const char *user_io_get_core_name_rbf();
 char *user_io_get_core_path(const char *suffix = NULL, int recheck = 0);
 const char *user_io_get_core_name_ex();
 void user_io_name_override(const char* name);
-- 
2.30.1

